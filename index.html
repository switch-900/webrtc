<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‚ö° P2P Game Relay</title>
<style>
body{font-family:system-ui,sans-serif;margin:0;padding:14px;background:#0d0d0d;color:#ccc;text-align:center}
h2{color:#f7931a;margin:0 0 4px;font-size:16px}
.sub{opacity:.65;font-size:11px;margin:0 0 10px}
.pill{display:inline-block;padding:3px 12px;border-radius:99px;font-size:12px;font-weight:800}
.ok{background:#1a4d2e;color:#6fcf97}.bad{background:#4d1a1a;color:#f28b82}.wait{background:#4d3e1a;color:#f5c842}
pre{background:#0b1020;color:#d6e1ff;padding:8px;border-radius:8px;overflow:auto;max-height:120px;font-size:10px;text-align:left;margin-top:8px}
.minbtn{background:#f7931a;color:#000;font-weight:900;cursor:pointer;border:none;padding:14px 32px;border-radius:12px;font-size:18px;margin:12px 0;display:block;width:100%}
.minbtn:hover{background:#ffaa33}
.stats{font-size:12px;margin:6px 0;opacity:.8}
#phone{font-family:monospace;color:#f7931a;font-size:13px;margin:6px 0;word-break:break-all}
</style>
</head>
<body>
<h2>‚ö° P2P Game Relay</h2>
<p class="sub">Inscription hex = phone number. Dial in & connect!</p>
<span id="status" class="pill bad">offline</span>
<div id="phone"></div>
<div class="stats">Peers: <b id="peerCount">0</b> ¬∑ Messages: <b id="msgCount">0</b></div>
<button class="minbtn" id="backBtn">‚¨á Minimize & Return</button>
<pre id="log">‚Ä¶</pre>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
(async()=>{
/* ‚îÄ‚îÄ DOM ‚îÄ‚îÄ */
const $=id=>document.getElementById(id);
const logEl=$("log"),statusEl=$("status"),peerCountEl=$("peerCount"),msgCountEl=$("msgCount");
const log=m=>{logEl.textContent=m+"\n"+logEl.textContent.slice(0,2000)};
const ss=(t,c)=>{statusEl.textContent=t;statusEl.className="pill "+(c||(t.includes("peer")?"ok":t.includes("‚Ä¶")?"wait":"bad"))};

/* ‚îÄ‚îÄ Lobby from URL hash (the inscription hex) ‚îÄ‚îÄ */
const LOBBY=decodeURIComponent((location.hash||"").replace(/^#/,""));
if(!LOBBY){ss("no lobby","bad");log("‚ùå No inscription hex in URL hash");return}

/* ‚îÄ‚îÄ Derive deterministic room "phone number" ‚îÄ‚îÄ */
const hashBuf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(LOBBY));
const PHONE="ord-"+[...new Uint8Array(hashBuf)].map(b=>b.toString(16).padStart(2,"0")).join("").slice(0,16);
$("phone").textContent="üìû "+PHONE;
log("üìû Phone #: "+PHONE);

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let opener=window.opener||((window.parent!==window)?window.parent:null);
let peer=null,isHost=false,ready=false,msgCount=0;
const mesh=new Map(); /* peerJsId ‚Üí DataConnection */

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function notifyReady(){
  if(opener)opener.postMessage(JSON.stringify({lobby:LOBBY,type:"relay-ready"}),"*");
}

function updateUI(){
  peerCountEl.textContent=mesh.size;
  if(!ready)return;
  ss(mesh.size?mesh.size+" peer"+(mesh.size>1?"s":""):"waiting for peers‚Ä¶",mesh.size?"ok":"wait");
}

/* ‚îÄ‚îÄ Wire up a PeerJS DataConnection ‚îÄ‚îÄ */
function wire(conn){
  conn.on("open",()=>{
    /* deduplicate */
    if(mesh.has(conn.peer)&&mesh.get(conn.peer).open){conn.close();return}
    mesh.set(conn.peer,conn);
    log("‚úÖ "+conn.peer.slice(-8)+" connected");
    updateUI();notifyReady();
    if(window.opener)try{window.opener.focus()}catch{}

    /* host ‚Üí introduce new peer to existing mesh */
    if(isHost){
      const others=[...mesh.keys()].filter(id=>id!==conn.peer);
      if(others.length)conn.send(JSON.stringify({_:"peers",ids:others}));
    }
  });

  conn.on("data",raw=>{
    let d;try{d=JSON.parse(typeof raw==="string"?raw:"")}catch{return}

    /* internal: peer list from host ‚Üí mesh with everyone */
    if(d._==="peers"){
      log("üìã Mesh: connecting to "+d.ids.length+" peer(s)");
      d.ids.forEach(id=>{
        if(!mesh.has(id)&&peer&&id!==peer.id)
          wire(peer.connect(id,{reliable:true,serialization:"none"}));
      });
      return;
    }

    /* game data ‚Üí forward to inscription */
    msgCount++;msgCountEl.textContent=msgCount;
    if(opener)opener.postMessage(JSON.stringify({lobby:LOBBY,type:"peer-msg",data:d}),"*");
  });

  conn.on("close",()=>{
    mesh.delete(conn.peer);
    log("‚ùå "+conn.peer.slice(-8)+" left");
    updateUI();

    /* host dropped ‚Äî try to reconnect or take over */
    if(conn.peer===PHONE&&!isHost){
      log("üëë Host left ‚Äî reconnecting in a moment‚Ä¶");
      setTimeout(()=>{
        if(peer&&peer.open){
          const c=peer.connect(PHONE,{reliable:true,serialization:"none"});
          wire(c);
        }
      },1500+Math.random()*2000);
    }
  });

  conn.on("error",e=>log("‚ö†Ô∏è "+conn.peer.slice(-8)+": "+e.type));
}

/* ‚îÄ‚îÄ postMessage bridge (inscription ‚Üî mesh) ‚îÄ‚îÄ */
window.addEventListener("message",ev=>{
  let msg;try{msg=typeof ev.data==="string"?JSON.parse(ev.data):ev.data}catch{return}
  if(!msg||msg.lobby!==LOBBY)return;
  if(ev.source)opener=ev.source;

  if(msg.type==="ping"){if(ready)notifyReady();return}

  /* forward game message to every mesh peer */
  const s=JSON.stringify(msg);
  for(const[,c]of mesh)if(c.open){try{c.send(s);msgCount++;msgCountEl.textContent=msgCount}catch{}}
});

/* ‚îÄ‚îÄ Claim the phone number (become host) ‚îÄ‚îÄ */
function claimHost(){
  return new Promise(resolve=>{
    peer=new Peer(PHONE,{debug:0});
    let done=false;

    peer.on("open",()=>{
      if(done)return;done=true;
      isHost=true;ready=true;
      log("üëë First caller ‚Äî you're the host");
      ss("waiting for peers‚Ä¶","wait");
      notifyReady();resolve(true);
    });

    peer.on("connection",c=>wire(c));

    peer.on("error",e=>{
      if(done)return;done=true;
      if(e.type==="unavailable-id")log("üìû Someone already hosting. Joining‚Ä¶");
      else log("‚ö†Ô∏è "+e.type);
      resolve(false);
    });

    peer.on("disconnected",()=>{
      if(isHost){log("‚ö†Ô∏è Signal lost ‚Äî reconnecting‚Ä¶");try{peer.reconnect()}catch{}}
    });

    setTimeout(()=>{if(!done){done=true;resolve(false)}},8000);
  });
}

/* ‚îÄ‚îÄ Dial in as a regular peer ‚îÄ‚îÄ */
function dial(){
  if(peer)try{peer.destroy()}catch{}
  peer=new Peer(undefined,{debug:0});

  peer.on("open",id=>{
    ready=true;
    log("üîó Your ID: "+id.slice(-8));
    log("üìû Calling host‚Ä¶");
    ss("connecting‚Ä¶","wait");
    notifyReady();
    wire(peer.connect(PHONE,{reliable:true,serialization:"none"}));
  });

  peer.on("connection",c=>wire(c)); /* mesh peers connecting to us */

  peer.on("error",e=>{
    if(e.type==="peer-unavailable"){
      log("üìû No host found ‚Äî becoming host‚Ä¶");
      claimHost().then(ok=>{if(!ok)setTimeout(dial,3000)});
    }else log("‚ö†Ô∏è "+e.type);
  });

  peer.on("disconnected",()=>{log("‚ö†Ô∏è Signal lost ‚Äî reconnecting‚Ä¶");try{peer.reconnect()}catch{}});
}

/* ‚îÄ‚îÄ Periodic: re-discover host if we lost them ‚îÄ‚îÄ */
setInterval(()=>{
  if(isHost||!peer||!peer.open)return;
  /* if not connected to host, try again */
  if(!mesh.has(PHONE)){
    log("üîÑ Re-dialing host‚Ä¶");
    wire(peer.connect(PHONE,{reliable:true,serialization:"none"}));
  }
},15000);

/* ‚îÄ‚îÄ Cleanup ‚îÄ‚îÄ */
window.addEventListener("beforeunload",()=>{if(peer)try{peer.destroy()}catch{}});

/* ‚îÄ‚îÄ Minimize ‚îÄ‚îÄ */
$("backBtn").onclick=()=>{
  try{window.resizeTo(200,80);window.moveTo(screen.width-220,screen.height-120)}catch{}
  if(window.opener)try{window.opener.focus()}catch{}
};

/* ‚îÄ‚îÄ GO: dial the phone number ‚îÄ‚îÄ */
ss("dialing‚Ä¶","wait");
log("üîç Dialing "+LOBBY.slice(0,16)+"‚Ä¶");
if(!await claimHost())dial();
})();
</script>
</body>
</html>
