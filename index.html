<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>⚡ Game Relay</title>
<style>
body{font-family:system-ui,sans-serif;margin:0;padding:14px;background:#0d0d0d;color:#ccc;text-align:center}
h2{color:#f7931a;margin:0 0 4px;font-size:16px}
.sub{opacity:.65;font-size:11px;margin:0 0 10px}
.pill{display:inline-block;padding:3px 12px;border-radius:99px;font-size:12px;font-weight:800}
.ok{background:#1a4d2e;color:#6fcf97}.bad{background:#4d1a1a;color:#f28b82}.wait{background:#4d3e1a;color:#f5c842}
pre{background:#0b1020;color:#d6e1ff;padding:8px;border-radius:8px;overflow:auto;max-height:100px;font-size:10px;text-align:left;margin-top:8px}
.minbtn{background:#f7931a;color:#000;font-weight:900;cursor:pointer;border:none;padding:14px 32px;border-radius:12px;font-size:18px;margin:12px 0;display:block;width:100%}
.minbtn:hover{background:#ffaa33}
.stats{font-size:12px;margin:6px 0;opacity:.8}
</style>
</head>
<body>
<h2>⚡ Game Relay</h2>
<p class="sub">Networking hub — connects your game to other players.</p>
<span id="status" class="pill bad">offline</span>
<div class="stats">Messages: <b id="msgCount">0</b></div>
<button class="minbtn" id="backBtn">⬇ Minimize & Return</button>
<pre id="log">…</pre>

<script>
(()=>{
const logEl=document.getElementById("log"),statusEl=document.getElementById("status");
const msgCountEl=document.getElementById("msgCount");

const log=(...a)=>{logEl.textContent=a.map(x=>typeof x==="string"?x:JSON.stringify(x)).join(" ")+"\n"+logEl.textContent.slice(0,2000)};
const ss=(t)=>{statusEl.textContent=t;statusEl.className="pill "+(t==="relaying"?"ok":t.includes("…")?"wait":"bad")};

/* ── Lobby from hash ── */
const LOBBY=decodeURIComponent((location.hash||"").replace(/^#/,""));
if(!LOBBY){ss("no lobby");log("❌ No lobby in URL hash.");return}

const WSS_URL="wss://ord-webrtc-signal.getord.workers.dev/ws?room="+encodeURIComponent(LOBBY);

let ws=null,openerRef=null,msgCount=0;

/* ── Connect to signaling server as broadcast hub ── */
function connectWS(){
  ss("connecting…");log("⏳ Connecting to room: "+LOBBY.slice(0,16)+"…");
  ws=new WebSocket(WSS_URL);

  ws.onopen=()=>{
    log("✅ WebSocket connected to room!");
    ss("relaying");
    /* Tell inscription we're ready */
    if(openerRef)openerRef.postMessage(JSON.stringify({lobby:LOBBY,type:"relay-ready"}),"*");
  };

  ws.onmessage=(ev)=>{
    msgCount++;msgCountEl.textContent=msgCount;
    /* Forward messages from other relays → inscription */
    if(openerRef){
      try{
        const msg=JSON.parse(ev.data);
        openerRef.postMessage(JSON.stringify({lobby:LOBBY,type:"peer-msg",data:msg}),"*");
      }catch(e){log("⚠️ Parse error: "+e)}
    }
  };

  ws.onclose=()=>{
    log("⚠️ WebSocket closed. Reconnecting in 3s…");
    ss("reconnecting…");
    setTimeout(connectWS,3000);
  };
  ws.onerror=()=>{log("❌ WebSocket error")};
}

/* ── Listen for postMessage from inscription ── */
window.addEventListener("message",(ev)=>{
  let msg;
  try{msg=typeof ev.data==="string"?JSON.parse(ev.data):ev.data}catch{return}
  if(!msg||msg.lobby!==LOBBY)return;
  if(ev.source)openerRef=ev.source;

  /* Ping → respond with relay-ready if WS is open */
  if(msg.type==="ping"){
    if(openerRef&&ws&&ws.readyState===1){
      openerRef.postMessage(JSON.stringify({lobby:LOBBY,type:"relay-ready"}),"*");
    }
    return;
  }

  /* Forward game messages → signaling server → all other relays */
  if(ws&&ws.readyState===1){
    const fwd={...msg};delete fwd.lobby; /* strip lobby field to save bandwidth */
    ws.send(JSON.stringify(fwd));
    msgCount++;msgCountEl.textContent=msgCount;
  }
});

/* ── Minimize button ── */
document.getElementById("backBtn").onclick=()=>{
  try{window.resizeTo(200,80);window.moveTo(screen.width-220,screen.height-120)}catch{}
  if(window.opener){try{window.opener.focus()}catch{}}
};

/* ── Start ── */
const parentRef=(window.parent!==window)?window.parent:window.opener;
if(parentRef)openerRef=parentRef;

connectWS();
log("Lobby: "+LOBBY.slice(0,20)+"…");
})();
</script>
</body>
</html>
