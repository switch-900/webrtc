<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‚ö° P2P Game Relay</title>
<style>
body{font-family:system-ui,sans-serif;margin:0;padding:14px;background:#0d0d0d;color:#ccc;text-align:center}
h2{color:#f7931a;margin:0 0 4px;font-size:16px}
.sub{opacity:.65;font-size:11px;margin:0 0 10px}
.pill{display:inline-block;padding:3px 12px;border-radius:99px;font-size:12px;font-weight:800}
.ok{background:#1a4d2e;color:#6fcf97}.bad{background:#4d1a1a;color:#f28b82}.wait{background:#4d3e1a;color:#f5c842}
pre{background:#0b1020;color:#d6e1ff;padding:8px;border-radius:8px;overflow:auto;max-height:100px;font-size:10px;text-align:left;margin-top:8px}
.minbtn{background:#f7931a;color:#000;font-weight:900;cursor:pointer;border:none;padding:14px 32px;border-radius:12px;font-size:18px;margin:12px 0;display:block;width:100%}
.minbtn:hover{background:#ffaa33}
.stats{font-size:12px;margin:6px 0;opacity:.8}
</style>
</head>
<body>
<h2>‚ö° P2P Game Relay</h2>
<p class="sub">Pure peer-to-peer ‚Äî no server needed.</p>
<span id="status" class="pill bad">offline</span>
<div class="stats">Peers: <b id="peerCount">0</b> ¬∑ Messages: <b id="msgCount">0</b></div>
<button class="minbtn" id="backBtn">‚¨á Minimize & Return</button>
<pre id="log">‚Ä¶</pre>

<script>
(async()=>{
const logEl=document.getElementById("log"),statusEl=document.getElementById("status");
const peerCountEl=document.getElementById("peerCount"),msgCountEl=document.getElementById("msgCount");
const log=(...a)=>{logEl.textContent=a.map(x=>typeof x==="string"?x:JSON.stringify(x)).join(" ")+"\n"+logEl.textContent.slice(0,2000)};
const ss=(t)=>{statusEl.textContent=t;statusEl.className="pill "+(t==="connected"?"ok":t.includes("‚Ä¶")?"wait":"bad")};

/* ‚îÄ‚îÄ Lobby from hash ‚îÄ‚îÄ */
const LOBBY=decodeURIComponent((location.hash||"").replace(/^#/,""));
if(!LOBBY){ss("no lobby");log("‚ùå No lobby in URL hash.");return}

/* ‚îÄ‚îÄ Config ‚îÄ‚îÄ */
const TRACKERS=["wss://tracker.openwebtorrent.com","wss://tracker.webtorrent.dev","wss://tracker.btorrent.xyz"];
const ICE=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}];
const NUM_OFFERS=5;
const REANNOUNCE=30000;

/* ‚îÄ‚îÄ Identity ‚îÄ‚îÄ */
const toHex=a=>Array.from(new Uint8Array(a)).map(b=>b.toString(16).padStart(2,"0")).join("");
const infoHash=toHex(await crypto.subtle.digest("SHA-1",new TextEncoder().encode(LOBBY)));
const peerId=toHex(crypto.getRandomValues(new Uint8Array(20)));

log("Room: "+infoHash.slice(0,12)+"‚Ä¶ | Me: "+peerId.slice(0,8)+"‚Ä¶");

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let openerRef=(window.parent!==window)?window.parent:window.opener;
let msgCount=0;
const activePeers=new Map();   /* remotePeerId ‚Üí {pc, dc} */
const pendingOffers=new Map(); /* offerId ‚Üí {pc, dc} */
let trackerWsList=[];

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function rndHex(n){return toHex(crypto.getRandomValues(new Uint8Array(n)))}

function waitForIce(pc){
  return new Promise(r=>{
    if(pc.iceGatheringState==="complete")return r();
    const fn=()=>{if(pc.iceGatheringState==="complete"){pc.removeEventListener("icegatheringstatechange",fn);r()}};
    pc.addEventListener("icegatheringstatechange",fn);
    setTimeout(r,5000);
  });
}

function updateUI(){
  peerCountEl.textContent=activePeers.size;
  if(activePeers.size>0)ss("connected");
  else if(trackerWsList.some(w=>w.readyState===1))ss("searching‚Ä¶");
  else ss("connecting‚Ä¶");
}

function notifyInscription(){
  if(openerRef)openerRef.postMessage(JSON.stringify({lobby:LOBBY,type:"relay-ready"}),"*");
}

/* ‚îÄ‚îÄ Data channel wiring ‚îÄ‚îÄ */
function setupDC(dc,remotePeerId,pc){
  dc.onopen=()=>{
    const ex=activePeers.get(remotePeerId);
    if(ex&&ex.dc.readyState==="open"){pc.close();return}
    activePeers.set(remotePeerId,{pc,dc});
    log("‚úÖ P2P link to "+remotePeerId.slice(0,8)+"‚Ä¶");
    updateUI();
    notifyInscription();
    if(window.opener){try{window.opener.focus()}catch{}}
  };
  dc.onmessage=(ev)=>{
    msgCount++;msgCountEl.textContent=msgCount;
    if(!openerRef)return;
    try{
      const m=JSON.parse(ev.data);
      openerRef.postMessage(JSON.stringify({lobby:LOBBY,type:"peer-msg",data:m}),"*");
    }catch{}
  };
  dc.onclose=()=>{
    const p=activePeers.get(remotePeerId);
    if(p&&p.dc===dc){activePeers.delete(remotePeerId);log("‚ö†Ô∏è Lost "+remotePeerId.slice(0,8)+"‚Ä¶");updateUI()}
  };
}

/* ‚îÄ‚îÄ Build outgoing offers ‚îÄ‚îÄ */
async function buildOffers(n){
  const out=[];
  for(let i=0;i<n;i++){
    const pc=new RTCPeerConnection({iceServers:ICE});
    const dc=pc.createDataChannel("game");
    const oid=rndHex(8);
    pendingOffers.set(oid,{pc,dc});
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    await waitForIce(pc);
    out.push({offer_id:oid,offer:{type:"offer",sdp:pc.localDescription.sdp}});
    setTimeout(()=>{if(pendingOffers.has(oid)){pendingOffers.delete(oid);try{pc.close()}catch{}}},60000);
  }
  return out;
}

/* ‚îÄ‚îÄ Incoming offer from tracker ‚Üí answer it ‚îÄ‚îÄ */
async function onTrackerOffer(msg,ws){
  const rid=msg.peer_id;
  if(rid===peerId||activePeers.has(rid))return;
  try{
    const pc=new RTCPeerConnection({iceServers:ICE});
    pc.ondatachannel=ev=>setupDC(ev.channel,rid,pc);
    await pc.setRemoteDescription({type:"offer",sdp:msg.offer.sdp});
    const ans=await pc.createAnswer();
    await pc.setLocalDescription(ans);
    await waitForIce(pc);
    ws.send(JSON.stringify({
      action:"announce",info_hash:infoHash,peer_id:peerId,
      to_peer_id:rid,offer_id:msg.offer_id,
      answer:{type:"answer",sdp:pc.localDescription.sdp}
    }));
    log("‚Ü©Ô∏è Answered "+rid.slice(0,8)+"‚Ä¶");
  }catch(e){log("‚ö†Ô∏è Offer err: "+e.message)}
}

/* ‚îÄ‚îÄ Incoming answer from tracker ‚Üí complete connection ‚îÄ‚îÄ */
async function onTrackerAnswer(msg){
  const oid=msg.offer_id,rid=msg.peer_id;
  const p=pendingOffers.get(oid);
  if(!p)return;
  pendingOffers.delete(oid);
  if(activePeers.has(rid)){p.pc.close();return}
  setupDC(p.dc,rid,p.pc);
  try{await p.pc.setRemoteDescription({type:"answer",sdp:msg.answer.sdp})}
  catch(e){log("‚ö†Ô∏è Answer err: "+e.message)}
  log("‚¨ÖÔ∏è Answer from "+rid.slice(0,8)+"‚Ä¶");
}

/* ‚îÄ‚îÄ Announce to a tracker ‚îÄ‚îÄ */
async function announce(ws,event){
  if(ws.readyState!==1)return;
  const offers=await buildOffers(NUM_OFFERS);
  const msg={action:"announce",info_hash:infoHash,peer_id:peerId,numwant:NUM_OFFERS,offers};
  if(event)msg.event=event;
  ws.send(JSON.stringify(msg));
  log("üì° Announced ("+offers.length+" offers)");
}

/* ‚îÄ‚îÄ Connect to a tracker ‚îÄ‚îÄ */
function connectTracker(url){
  const tag=url.split("//")[1]?.split("/")[0]||url;
  const ws=new WebSocket(url);
  ws.onopen=()=>{
    log("‚úÖ Tracker: "+tag);
    trackerWsList.push(ws);
    updateUI();
    announce(ws,"started");
  };
  ws.onmessage=ev=>{
    try{
      const m=JSON.parse(ev.data);
      if(m.offer)onTrackerOffer(m,ws);
      else if(m.answer)onTrackerAnswer(m);
    }catch{}
  };
  ws.onclose=()=>{
    trackerWsList=trackerWsList.filter(s=>s!==ws);
    log("‚ö†Ô∏è Tracker lost: "+tag);
    updateUI();
    setTimeout(()=>connectTracker(url),10000);
  };
  ws.onerror=()=>{};
}

/* ‚îÄ‚îÄ Re-announce periodically to find new peers ‚îÄ‚îÄ */
setInterval(()=>{
  for(const ws of trackerWsList)announce(ws);
},REANNOUNCE);

/* ‚îÄ‚îÄ Listen for postMessage from inscription ‚îÄ‚îÄ */
window.addEventListener("message",ev=>{
  let msg;
  try{msg=typeof ev.data==="string"?JSON.parse(ev.data):ev.data}catch{return}
  if(!msg||msg.lobby!==LOBBY)return;
  if(ev.source)openerRef=ev.source;

  if(msg.type==="ping"){
    if(trackerWsList.some(w=>w.readyState===1))notifyInscription();
    return;
  }

  /* Forward to all connected peers via data channels */
  const fwd=JSON.stringify((({lobby,...r})=>r)(msg));
  for(const[,{dc}]of activePeers){
    if(dc.readyState==="open"){try{dc.send(fwd);msgCount++;msgCountEl.textContent=msgCount}catch{}}
  }
});

/* ‚îÄ‚îÄ Cleanup on close ‚îÄ‚îÄ */
window.addEventListener("beforeunload",()=>{
  for(const ws of trackerWsList){
    try{ws.send(JSON.stringify({action:"announce",info_hash:infoHash,peer_id:peerId,event:"stopped"}))}catch{}
  }
});

/* ‚îÄ‚îÄ Minimize button ‚îÄ‚îÄ */
document.getElementById("backBtn").onclick=()=>{
  try{window.resizeTo(200,80);window.moveTo(screen.width-220,screen.height-120)}catch{}
  if(window.opener){try{window.opener.focus()}catch{}}
};

/* ‚îÄ‚îÄ Start ‚îÄ‚îÄ */
ss("connecting‚Ä¶");
log("üîç Finding peers for "+LOBBY.slice(0,16)+"‚Ä¶");
TRACKERS.forEach(connectTracker);
})();
</script>
</body>
</html>
